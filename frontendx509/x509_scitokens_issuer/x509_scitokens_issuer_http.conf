Listen 8843
<VirtualHost _default_:8843>

# uncomment GridSiteEnvs if we'll use mod_gridsite apache module (see frontend/deploy)
#  GridSiteEnvs on

  SSLEngine on
  SSLProtocol ALL -SSLv2 -SSLv3
  SSLCipherSuite  ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:!DSS
  SSLCertificateFile /data/certs/hostcert.pem
  SSLCertificateKeyFile /data/certs/hostkey.pem
  SSLCACertificatePath /etc/grid-security/certificates
  SSLCARevocationPath /etc/grid-security/certificates
  SSLCARevocationCheck chain
  SSLOptions +StrictRequire +StdEnvVars +ExportCertData +LegacyDNStringFormat
  SSLVerifyClient optional
  SSLVerifyDepth 10
  SSLHonorCipherOrder On
  TraceEnable Off

  # This will mount the issuer at / (may want to change to /foo for a VO named foo.
  WSGIScriptAlias / @STATEDIR@/wsgi/x509-scitokens-issuer.wsgi

  # A modest number of processes and threads; production applications may want to increase this.
  WSGIDaemonProcess x509-scitokens processes=1 threads=2 display-name=%{GROUP}
  WSGIProcessGroup x509-scitokens

  # Recommendation from upstream mod_wsgi developers.
  LogLevel info

  # Required for wsgi directory to allow executing WSGI.
  <Directory @STATEDIR@/wsgi>
    AllowOverride None
    Order allow,deny
    Allow from all
    Require all granted
  </Directory>
  
    SSLProxyEngine on

  <Location />
    # Require strong encryption.  This is defence in depth, this is
    # technically unnecessary due to SSLCipherSuite definition.
    SSLRequire (%{SSL_CIPHER_USEKEYSIZE} >= 128 and %{SSL_CIPHER} !~ m/^(EXP|NULL)/)

    # Always require SSL when talking to this port.  This will not
    # prevent a client from compromising itself (the request will
    # already have been sent in clear on the wire by the time it is
    # rejected), but does protect the server, does prevent reasonable
    # web browser clients from sending "secure" cookies over an
    # insecure connection, and does limit malicious attempts to
    # fool humans the access is secure when in fact it is not.
    SSLRequireSSL

    # Increase SSL renegotiation buffer size.
    SSLRenegBufferSize 1048576
  </Location>

  # If we've verified certificate, pass the info to the back-end.
  RequestHeader set SSL_CLIENT_CERT %{SSL_CLIENT_CERT}e
  RequestHeader set SSL_CLIENT_S_DN %{SSL_CLIENT_S_DN}e
  RequestHeader set SSL_CLIENT_VERIFY %{SSL_CLIENT_VERIFY}e
  RequestHeader set HTTPS %{HTTPS}e

  # Tell backends the request was https
  RequestHeader set X-Forwarded-Proto "https"

  # Enable rewrite engine and disable (again) all request methods except
  # HEAD, POST, GET, PUT and DELETE.  In particular make sure TRACE and
  # TRACK cannot be used.  This is defence in depth, the "TraceEnable Off"
  # in the main server configuration should already disable these methods;
  # the rules below are just a precaution to avoid accidents.
  RewriteEngine on
  RewriteCond %{REQUEST_METHOD} !^(HEAD|POST|GET|PUT|DELETE)$
  RewriteRule ^ - [F]

  # Capture the URI for the backend; need mod_rewrite to grab it.
  RewriteCond %{ENV:REDIRECT_REQUEST_URI} !^$
  RewriteRule ^ - [E=CMS_REQUEST_URI:%{ENV:REDIRECT_REQUEST_URI}]
  RewriteCond %{ENV:REDIRECT_REQUEST_URI} ^$
  RewriteRule ^ - [E=CMS_REQUEST_URI:%{REQUEST_URI}]
  RequestHeader set CMS-Request-URI %{CMS_REQUEST_URI}e

  # Add 'escape' rewrite map to name space.  Extract query for redirects.
  RewriteMap escape int:escape
  RewriteCond %{QUERY_STRING} ^$
  RewriteRule ^ - [E=CMS_QUERY:]
  RewriteCond %{QUERY_STRING} !^$
  RewriteRule ^ - [E=CMS_QUERY:?%{QUERY_STRING}]

  # Application configurations.
  @INCLUDE auth.conf@
  @INCLUDE app_*_ssl.conf@

</VirtualHost>

